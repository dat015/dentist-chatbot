<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Assistant Chat Client</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat-window { border: 1px solid #ccc; height: 300px; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .user { color: blue; }
        .bot { color: green; }
        .status { color: orange; font-style: italic; font-size: 0.8em; }
    </style>
</head>
<body>

    <h2>ü§ñ Tr·ª£ l√Ω AI Nha khoa</h2>
    <div id="chat-window"></div>
    <input type="text" id="user-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." style="width: 80%;">
    <button onclick="sendMessage()">G·ª≠i</button>
    <p class="status" id="connection-status">ƒêang k·∫øt n·ªëi...</p>
    <p class="status" id="processing-status"></p>

    <script>
        // Thay ƒë·ªïi URL n√†y n·∫øu Server c·ªßa b·∫°n ch·∫°y ·ªü port kh√°c
        const SOCKET_URL = 'http://localhost:5000'; 
        const USER_ID = 'test_user_123'; // ID ng∆∞·ªùi d√πng c·ªë ƒë·ªãnh ƒë·ªÉ test l·ªãch s·ª≠ chat

        // Kh·ªüi t·∫°o k·∫øt n·ªëi Socket.IO
        const socket = io(SOCKET_URL, { transports: ['websocket'] });
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const connectionStatus = document.getElementById('connection-status');
        const processingStatus = document.getElementById('processing-status');

        // --- H√†m hi·ªÉn th·ªã tin nh·∫Øn ---
        function appendMessage(sender, text, type = 'message') {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);
            if (type === 'status') {
                msgDiv.classList.add('status');
                msgDiv.innerHTML = `[Tr·∫°ng th√°i]: ${text}`;
            } else {
                const prefix = (sender === 'user') ? 'B·∫°n: ' : 'AI: ';
                msgDiv.innerHTML = `<strong>${prefix}</strong>${text}`;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Cu·ªôn xu·ªëng cu·ªëi
        }

        // --- Logic G·ª≠i Tin nh·∫Øn ---
        window.sendMessage = function() {
            const text = userInput.value.trim();
            if (text === '') return;

            // 1. G·ª≠i tin nh·∫Øn l√™n giao di·ªán
            appendMessage('user', text);
            
            // 2. G·ª≠i event qua Socket.IO
            socket.emit('question:send', { userId: USER_ID, text: text });

            // 3. X√≥a input v√† disable
            userInput.value = '';
            userInput.disabled = true;
        }

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- L·∫Øng nghe c√°c s·ª± ki·ªán t·ª´ Server (ServerToClientEvents) ---
        
        // 1. K·∫øt n·ªëi th√†nh c√¥ng
        socket.on('connect', () => {
            connectionStatus.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi Socket.IO';
            console.log(`Connected with ID: ${socket.id}`);
            userInput.disabled = false;
        });

        // 2. M·∫•t k·∫øt n·ªëi
        socket.on('disconnect', () => {
            connectionStatus.textContent = '‚ùå M·∫•t k·∫øt n·ªëi';
            userInput.disabled = true;
        });

        // 3. Server nh·∫≠n ƒë∆∞·ª£c c√¢u h·ªèi
        socket.on('question:ack', (payload) => {
            processingStatus.textContent = `...Server ƒë√£ nh·∫≠n: "${payload.text}"`;
        });

        // 4. C·∫≠p nh·∫≠t tr·∫°ng th√°i x·ª≠ l√Ω
        socket.on('status:update', (payload) => {
            processingStatus.textContent = `...ƒêang x·ª≠ l√Ω: ${payload.stage} (${JSON.stringify(payload.meta || {})})`;
            appendMessage('system', `B·∫Øt ƒë·∫ßu b∆∞·ªõc: **${payload.stage}**`, 'status');
        });

        // 5. Ho√†n th√†nh v√† c√≥ c√¢u tr·∫£ l·ªùi cu·ªëi c√πng
        socket.on('question:done', (payload) => {
            appendMessage('bot', payload.answer);
            processingStatus.textContent = `‚úÖ Ho√†n th√†nh. Ch·∫•t l∆∞·ª£ng: ${payload.quality.label}`;
            userInput.disabled = false;
        });

        // 6. X·∫£y ra l·ªói
        socket.on('question:error', (payload) => {
            appendMessage('system', `L·ªñI: ${payload.message}`, 'status');
            processingStatus.textContent = `‚ùå L·ªói x·ª≠ l√Ω`;
            userInput.disabled = false;
        });

    </script>
</body>
</html>